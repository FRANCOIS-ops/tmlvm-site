<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Win ‚ÄúWork Less, Live Better‚Äù</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Montserrat:wght@100;200;300;400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --yellow: #fee600;
            --blue: #00aee3;
        }

        html,
        body {
            height: 100%;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            margin: 0;
            padding: 0;
            overflow: hidden;
            overscroll-behavior: none;
            background: #fff;
        }

        .scratch-canvas {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            touch-action: none;
            transition: opacity 350ms ease;
        }

        .hidden {
            display: none !important;
        }

        .modal-backdrop {
            background: rgba(0, 0, 0, 0.55);
            backdrop-filter: blur(6px);
        }

        .card-grad {
            background: linear-gradient(135deg, var(--blue) 0%, #0087b3 100%);
        }

        .wheel {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            position: relative;
            overflow: hidden;
            transition: transform 4s cubic-bezier(0.17, 0.67, 0.12, 0.99);
            background: #fff;
            cursor: pointer;
        }

        .wheel-segment {
            position: absolute;
            width: 50%;
            height: 50%;
            transform-origin: 100% 100%;
            display: grid;
            place-items: start center;
            padding-top: 34px;
            font-weight: 900;
            letter-spacing: 0.02em;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.25);
            user-select: none;
        }

        .wheel-segment span {
            display: inline-block;
            line-height: 1.05;
        }

        .pointer {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 14px solid transparent;
            border-right: 14px solid transparent;
            border-top: 28px solid var(--yellow);
            z-index: 10;
            filter: drop-shadow(0 6px 10px rgba(0, 0, 0, 0.25));
        }

        .center-circle {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 66px;
            height: 66px;
            background: var(--yellow);
            border-radius: 999px;
            z-index: 5;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            color: #000;
            font-size: 14px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.18);
            user-select: none;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <!-- SCRATCH GAME: grey scratch layer on top of the prize image (progressively revealed) -->
    <main id="scratchGame" class="fixed inset-0">
        <!-- Prize layer (visible progressively as user scratches). -->
        <div id="prizeLayer" class="absolute inset-0 grid place-items-center p-6 bg-white">
            <div id="prizeCard"
                class="w-full max-w-3xl rounded-3xl card-grad text-white shadow-2xl border border-white/10 overflow-hidden">
                <div class="px-6 pt-6 pb-5 text-center">
                    <div class="text-2xl sm:text-3xl font-black tracking-tight">Work Less, Live Better</div>
                    <div class="text-white/85 text-sm sm:text-base font-medium">Scratch to reveal your chance</div>
                </div>
                <div class="px-6 pb-7">
                    <div id="prizeBooks" class="grid gap-3 sm:gap-4"></div>
                </div>
            </div>
        </div>

        <canvas id="scratchCanvas" class="scratch-canvas"></canvas>
    </main>

    <!-- OUTCOME POPUP (shown at 70% scratched) -->
    <div id="outcomeModal" class="hidden fixed inset-0 z-50">
        <div class="absolute inset-0 modal-backdrop"></div>
        <div class="absolute inset-0 grid place-items-center p-4">
            <div
                class="w-full max-w-2xl rounded-3xl card-grad text-white shadow-2xl border border-white/10 overflow-hidden">
                <div class="flex items-center justify-between px-6 py-5">
                    <div>
                        <div id="outcomeTitle" class="text-2xl sm:text-3xl font-black tracking-tight">Result</div>
                        <div id="outcomeSubtitle" class="text-white/85 text-sm sm:text-base font-medium"></div>
                    </div>
                    <button id="closeOutcome"
                        class="h-10 w-10 rounded-full bg-white/10 hover:bg-white/15 active:bg-white/20 transition grid place-items-center"
                        aria-label="Close">
                        <span class="text-xl font-black">√ó</span>
                    </button>
                </div>

                <div class="px-6 pb-6">
                    <!-- WIN CONTENT -->
                    <section id="winContent" class="hidden">
                        <div class="text-center mb-5">
                            <img alt="Book cover"
                                src="https://FRANCOIS-ops.github.io/tmlvm-site/assets/images/book-cover-en.png"
                                class="w-48 h-auto mx-auto rounded-lg shadow-lg" />
                        </div>

                        <div class="text-center">
                            <div
                                class="inline-block bg-white text-black px-6 py-3 rounded-2xl font-black text-xl sm:text-2xl">
                                Code: 823820</div>
                            <p class="mt-4 text-base sm:text-lg font-medium text-white/95">
                                Please send the code to <span class="font-bold">francois.leborgne@gmail.com</span> to
                                get your free book.
                                <span class="font-bold">First 5 persons to send this code win a book</span>
                            </p>
                        </div>

                        <div class="mt-6 flex flex-col sm:flex-row gap-3 justify-center">
                            <button id="winCopyEmail"
                                class="px-5 py-3 rounded-full bg-[var(--yellow)] text-black font-black hover:brightness-95 active:brightness-90 transition">
                                Copy email
                            </button>
                        </div>
                    </section>

                    <!-- LOSE CONTENT -->
                    <section id="loseContent" class="hidden">
                        <div id="lostMessageLink"
                            class="bg-[var(--blue)] text-white p-6 rounded-2xl mb-6 text-center shadow-xl cursor-pointer hover:brightness-110 transition">
                            <div class="text-3xl font-black mb-2">Keep Going!</div>
                            <div class="text-xl underline decoration-2 underline-offset-4">You get another chance to win
                                : spin the wheel!
                            </div>
                        </div>

                        <div class="flex flex-row justify-center gap-4 mb-6">
                            <img alt="Book cover English" src="assets/images/book-cover-en.png"
                                class="h-32 sm:h-48 w-auto rounded-lg shadow-lg opacity-90 object-contain" />
                            <img alt="Book cover French" src="assets/images/book-cover-fr.png"
                                class="h-32 sm:h-48 w-auto rounded-lg shadow-lg opacity-90 object-contain" />
                        </div>

                        <div class="mt-4 flex flex-col sm:flex-row gap-3 justify-center">
                            <button id="goToWheel"
                                class="px-5 py-3 rounded-full bg-[var(--yellow)] text-black font-black hover:brightness-95 active:brightness-90 transition text-lg">
                                üé≤ Try Again ‚Äì Spin the Wheel
                            </button>
                        </div>
                    </section>
                </div>
            </div>
        </div>
    </div>

    <!-- WHEEL OF FORTUNE -->
    <section id="wheelGame" class="hidden fixed inset-0 z-40 bg-white flex flex-col items-center justify-center p-4">
        <h2 class="text-4xl font-black text-[var(--blue)] mb-2 text-center">Spin to Win</h2>
        <p class="text-gray-600 mb-8 text-center">One more chance for the book!</p>

        <div class="relative w-[300px] h-[300px] sm:w-[340px] sm:h-[340px] mb-8 shrink-0">
            <div class="pointer"></div>
            <div id="wheel" class="wheel shadow-2xl"></div>
            <div class="center-circle">SPIN</div>
        </div>

        <button id="spinButton"
            class="w-full sm:w-auto bg-[var(--yellow)] text-gray-900 font-black py-4 px-10 rounded-full transition-all transform hover:scale-[1.02] active:scale-[0.99] disabled:opacity-50 disabled:cursor-not-allowed shadow-xl text-lg">
            Spin the Wheel!
        </button>

        <div id="wheelResult" class="hidden mt-6 text-center p-4 rounded-2xl max-w-xl"></div>
    </section>

    <!-- THANK YOU (embedded Google Form) -->
    <section id="thankYou" class="hidden fixed inset-0 z-40 w-full h-screen bg-white overflow-y-auto">
        <div class="min-h-screen w-full flex flex-col items-center justify-start p-6 text-center">
            <div class="mt-2 mb-5">
                <img src="https://FRANCOIS-ops.github.io/tmlvm-site/assets/images/book-cover-en.png"
                    alt="Work Less, Live Better book cover"
                    class="max-h-[32vh] w-auto mx-auto rounded-2xl shadow-2xl object-contain" />
            </div>


            <div class="w-full max-w-2xl bg-white border border-gray-200 rounded-3xl shadow-lg p-3 sm:p-4">
                <div class="h-[65vh] sm:h-[80vh] w-full">
                    <iframe
                        src="https://docs.google.com/forms/d/e/1FAIpQLSeyoASer3cOZ5sGwz-8j8zGCDi2hhYLXvWDbfzi-XJ-DHG39g/viewform?embedded=true"
                        class="w-full h-full rounded-2xl" frameborder="0" marginheight="0"
                        marginwidth="0">Chargement‚Ä¶</iframe>
                </div>
                <p class="mt-4 text-[11px] sm:text-xs text-gray-500 leading-snug">
                    By submitting this form, you agree to receive occasional emails about ‚ÄúWork Less, Live Better‚Äù.
                    Your data is processed in accordance with GDPR. You can unsubscribe at any time using the link
                    provided in our emails.
                </p>
            </div>

            <div class="mt-8 mb-12">
                <button id="replayGame"
                    class="px-6 py-3 rounded-full bg-gray-200 text-gray-700 font-bold hover:bg-gray-300 transition shadow-sm">
                    Replay Game (Reset)
                </button>
            </div>
        </div>
    </section>

    <script>
        const BOOK_IMG = 'https://FRANCOIS-ops.github.io/tmlvm-site/assets/images/book-cover-en.png';

        // Scratch config
        const SCRATCH_THRESHOLD = 0.46; // 46% scratched -> show popup
        const SCRATCH_GREY = '#4B5563';

        let scratch = {
            isWin: false,
            revealed: false,
            isDrawing: false,
            lastPoint: null,
            rafPending: false,
            ctx: null,
            canvas: null,
            w: 0,
            h: 0,
            dpr: 1,
            brush: 52,
            inputScale: 1
        };

        document.addEventListener('DOMContentLoaded', () => {
            loadState();

            // If state wasn't loaded (new game), init random
            if (scratch.isWin === null) {
                scratch.isWin = Math.random() < 0.03;
                saveState();
            } else {
                // State loaded. If revealed, hide scratch and show outcome/wheel
                if (scratch.revealed) {
                    document.getElementById('scratchGame').classList.add('hidden');

                    // Check if wheel was already spun
                    const wheelState = JSON.parse(localStorage.getItem('tmlvm_wheel')) || {};
                    if (wheelState.spun) {
                        // Show thank you page directly
                        document.getElementById('wheelGame').classList.add('hidden');
                        document.getElementById('thankYou').classList.remove('hidden');
                    } else {
                        // Show wheel
                        document.getElementById('wheelGame').classList.remove('hidden');
                        initWheel(); // Re-init wheel to be sure
                    }
                }
            }

            if (!scratch.revealed) {
                initScratch();
            }
            // Always init wheel in case we need it later
            if (!document.getElementById('wheelGame').classList.contains('hidden')) {
                initWheel();
            } else {
                // Init wheel anyway so it's ready
                initWheel();
            }


            // Google Form is now embedded - no need for button click handler

            // Modal buttons
            document.getElementById('closeOutcome').addEventListener('click', () => hideOutcome());
            document.getElementById('goToWheel').addEventListener('click', () => {
                hideOutcome();
                document.getElementById('scratchGame').classList.add('hidden');
                document.getElementById('wheelGame').classList.remove('hidden');
            });
            document.getElementById('lostMessageLink').addEventListener('click', () => {
                hideOutcome();
                document.getElementById('scratchGame').classList.add('hidden');
                document.getElementById('wheelGame').classList.remove('hidden');
            });
            document.getElementById('winCopyEmail').addEventListener('click', async () => {
                try {
                    await navigator.clipboard.writeText('francois.leborgne@gmail.com');
                    const btn = document.getElementById('winCopyEmail');
                    const prev = btn.textContent;
                    btn.textContent = 'Copied!';
                    setTimeout(() => (btn.textContent = prev), 1200);
                } catch {
                    alert('Email: francois.leborgne@gmail.com');
                }
            });

            // Replay button
            document.getElementById('replayGame').addEventListener('click', () => {
                localStorage.removeItem('tmlvm_scratch');
                localStorage.removeItem('tmlvm_wheel');
                location.reload();
            });

            // Swipe Gesture for Wheel
            const wheelSection = document.getElementById('wheelGame');
            let touchStartX = 0;
            let touchStartY = 0;

            wheelSection.addEventListener('touchstart', (e) => {
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
            }, { passive: false });

            wheelSection.addEventListener('touchmove', (e) => {
                const touchX = e.touches[0].clientX;
                const touchY = e.touches[0].clientY;
                const deltaX = touchX - touchStartX;
                const deltaY = touchY - touchStartY;

                // Check for diagonal movement: top-left to bottom-right
                // We require a minimum movement to consider it a swipe
                if (deltaX > 30 && deltaY > 30) {
                    // It matches our gesture! Prevent default to stop refresh
                    e.preventDefault();
                }
            }, { passive: false });

            wheelSection.addEventListener('touchend', (e) => {
                const touchEndX = e.changedTouches[0].clientX;
                const touchEndY = e.changedTouches[0].clientY;
                const deltaX = touchEndX - touchStartX;
                const deltaY = touchEndY - touchStartY;

                // Logic: significant movement down and right
                if (deltaX > 60 && deltaY > 60) {
                    const btn = document.getElementById('spinButton');
                    if (!btn.disabled && !document.getElementById('wheelGame').classList.contains('hidden')) {
                        spinWheel();
                    }
                }
            });


            // Resize handling
            window.addEventListener('resize', () => {
                if (!document.getElementById('scratchGame').classList.contains('hidden')) {
                    restartScratch(true);
                }
            });
        });

        function saveState() {
            const state = {
                isWin: scratch.isWin,
                revealed: scratch.revealed
            };
            localStorage.setItem('tmlvm_scratch', JSON.stringify(state));
        }

        function loadState() {
            const saved = localStorage.getItem('tmlvm_scratch');
            if (saved) {
                const state = JSON.parse(saved);
                scratch.isWin = state.isWin;
                scratch.revealed = state.revealed;
            } else {
                scratch.isWin = null; // Signal not loaded
            }
        }

        function initScratch() {
            scratch.canvas = document.getElementById('scratchCanvas');
            scratch.ctx = scratch.canvas.getContext('2d', { willReadFrequently: true });
            scratch.canvas.style.touchAction = 'none';

            renderPrizeLayer();
            setupScratchSurface();
            bindScratchEvents();
        }

        function setupScratchSurface() {
            const canvas = scratch.canvas;
            const ctx = scratch.ctx;

            // High-DPI scale
            scratch.dpr = Math.max(1, Math.min(3, window.devicePixelRatio || 1));
            scratch.w = Math.floor(window.innerWidth);
            scratch.h = Math.floor(window.innerHeight);

            canvas.width = Math.floor(scratch.w * scratch.dpr);
            canvas.height = Math.floor(scratch.h * scratch.dpr);
            canvas.style.width = scratch.w + 'px';
            canvas.style.height = scratch.h + 'px';

            ctx.setTransform(scratch.dpr, 0, 0, scratch.dpr, 0, 0);

            // Brush size: mobile friendly
            const minDim = Math.min(scratch.w, scratch.h);
            scratch.brush = Math.max(36, Math.min(92, Math.round(minDim * 0.085)));
            scratch.inputScale = ('ontouchstart' in window || navigator.maxTouchPoints > 0) ? 0.65 : 1;

            // Reset state
            scratch.revealed = false;
            scratch.isDrawing = false;
            scratch.lastPoint = null;
            scratch.rafPending = false;
            canvas.style.opacity = '1';
            canvas.style.pointerEvents = 'auto';

            // Ensure prize matches current outcome
            renderPrizeLayer();
            drawScratchOverlay();
        }

        function drawScratchOverlay() {
            const ctx = scratch.ctx;

            // Solid grey
            ctx.globalCompositeOperation = 'source-over';
            ctx.clearRect(0, 0, scratch.w, scratch.h);
            ctx.fillStyle = SCRATCH_GREY;
            ctx.fillRect(0, 0, scratch.w, scratch.h);

            // Texture noise
            ctx.fillStyle = 'rgba(255,255,255,0.08)';
            for (let i = 0; i < 1100; i++) {
                const x = Math.random() * scratch.w;
                const y = Math.random() * scratch.h;
                const r = Math.random() * 3.2;
                ctx.beginPath();
                ctx.arc(x, y, r, 0, Math.PI * 2);
                ctx.fill();
            }

            // Instruction text ON the scratch layer (and scratches away)
            const fontSize = Math.max(18, Math.min(36, Math.round(Math.min(scratch.w, scratch.h) * 0.045)));
            ctx.fillStyle = 'rgba(255,255,255,0.96)';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.font = `800 ${fontSize}px Montserrat, sans-serif`;

            const message = 'Scratch this card - discover 5 books and win one';
            wrapText(ctx, message, scratch.w / 2, scratch.h / 2, Math.min(760, scratch.w * 0.88), fontSize * 1.18);

            // subtle highlight line
            ctx.globalAlpha = 0.12;
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, scratch.w, 1);
            ctx.globalAlpha = 1;
        }

        function renderPrizeLayer() {
            const books = document.getElementById('prizeBooks');
            if (!books) return;

            const isWin = !!scratch.isWin;
            const count = isWin ? 5 : 4;

            books.className = isWin
                ? 'grid grid-cols-3 sm:grid-cols-5 gap-3 sm:gap-4'
                : 'grid grid-cols-2 sm:grid-cols-4 gap-3 sm:gap-4';

            books.innerHTML = '';
            for (let i = 0; i < count; i++) {
                const img = document.createElement('img');
                img.alt = 'Book cover';
                img.src = BOOK_IMG;
                img.className = 'w-full rounded-lg shadow-lg';
                books.appendChild(img);
            }
        }

        function wrapText(ctx, text, x, y, maxWidth, lineHeight) {
            const words = text.split(' ');
            let line = '';
            const lines = [];

            for (let n = 0; n < words.length; n++) {
                const testLine = line + words[n] + ' ';
                const metrics = ctx.measureText(testLine);
                if (metrics.width > maxWidth && n > 0) {
                    lines.push(line.trim());
                    line = words[n] + ' ';
                } else {
                    line = testLine;
                }
            }
            lines.push(line.trim());

            const totalHeight = (lines.length - 1) * lineHeight;
            const startY = y - totalHeight / 2;

            lines.forEach((l, i) => ctx.fillText(l, x, startY + i * lineHeight));
        }

        function bindScratchEvents() {
            const canvas = scratch.canvas;

            const getPoint = (e) => {
                const rect = canvas.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const clientY = e.touches ? e.touches[0].clientY : e.clientY;
                return { x: clientX - rect.left, y: clientY - rect.top };
            };

            const onDown = (e) => {
                if (scratch.revealed) return;
                scratch.isDrawing = true;
                scratch.lastPoint = getPoint(e);
                scratchAt(scratch.lastPoint.x, scratch.lastPoint.y, true);
                e.preventDefault();
            };

            const onMove = (e) => {
                if (!scratch.isDrawing || scratch.revealed) return;
                const p = getPoint(e);
                scratchLine(scratch.lastPoint, p);
                scratch.lastPoint = p;
                maybeCheckReveal();
                e.preventDefault();
            };

            const onUp = () => {
                scratch.isDrawing = false;
                scratch.lastPoint = null;
            };

            // Remove old listeners if any (safe on re-init)
            canvas.onmousedown = null;
            canvas.onmousemove = null;
            canvas.onmouseup = null;
            canvas.onmouseleave = null;
            canvas.ontouchstart = null;
            canvas.ontouchmove = null;
            canvas.ontouchend = null;
            canvas.ontouchcancel = null;

            canvas.addEventListener('mousedown', onDown);
            canvas.addEventListener('mousemove', onMove);
            canvas.addEventListener('mouseup', onUp);
            canvas.addEventListener('mouseleave', onUp);

            canvas.addEventListener('touchstart', onDown, { passive: false });
            canvas.addEventListener('touchmove', onMove, { passive: false });
            canvas.addEventListener('touchend', onUp, { passive: true });
            canvas.addEventListener('touchcancel', onUp, { passive: true });
        }

        function scratchAt(x, y, heavy = false) {
            const ctx = scratch.ctx;
            const base = heavy ? scratch.brush : scratch.brush * 0.95;
            const r = base * scratch.inputScale;

            ctx.globalCompositeOperation = 'destination-out';
            ctx.beginPath();
            ctx.arc(x, y, r, 0, Math.PI * 2);
            ctx.fill();

            // Natural edges
            for (let i = 0; i < 2; i++) {
                const ox = x + (Math.random() - 0.5) * r * 1.1;
                const oy = y + (Math.random() - 0.5) * r * 1.1;
                ctx.beginPath();
                ctx.arc(ox, oy, r * 0.65, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        function scratchLine(a, b) {
            if (!a || !b) return;
            const dx = b.x - a.x;
            const dy = b.y - a.y;
            const dist = Math.hypot(dx, dy);
            const step = Math.max(6, scratch.brush * 0.35);
            const n = Math.max(1, Math.floor(dist / step));

            for (let i = 0; i <= n; i++) {
                const t = i / n;
                scratchAt(a.x + dx * t, a.y + dy * t, false);
            }
        }

        function maybeCheckReveal() {
            if (scratch.rafPending || scratch.revealed) return;
            scratch.rafPending = true;
            requestAnimationFrame(() => {
                scratch.rafPending = false;
                checkReveal();
            });
        }

        function checkReveal() {
            if (scratch.revealed) return;

            const ctx = scratch.ctx;
            // Read pixels in device pixels; we set transform for drawing, but imageData is in backing store.
            const data = ctx.getImageData(0, 0, scratch.canvas.width / scratch.dpr, scratch.canvas.height / scratch.dpr).data;

            // Sample grid for performance
            const w = scratch.w;
            const h = scratch.h;
            const step = Math.max(16, Math.floor(Math.min(w, h) / 28));

            let total = 0;
            let cleared = 0;

            for (let y = 0; y < h; y += step) {
                for (let x = 0; x < w; x += step) {
                    const idx = (y * w + x) * 4 + 3;
                    total++;
                    if (data[idx] < 128) cleared++;
                }
            }

            const percent = cleared / total;
            if (percent >= SCRATCH_THRESHOLD) {
                scratch.revealed = true;
                saveState(); // Save revealed state
                scratch.canvas.style.pointerEvents = 'none';
                scratch.canvas.style.opacity = '0';

                setTimeout(() => {
                    showOutcome();
                }, 220);
            }
        }

        function showOutcome() {
            const modal = document.getElementById('outcomeModal');
            const winContent = document.getElementById('winContent');
            const loseContent = document.getElementById('loseContent');
            const closeBtn = document.getElementById('closeOutcome');

            const title = document.getElementById('outcomeTitle');
            const subtitle = document.getElementById('outcomeSubtitle');

            // Popup is only the announcement; the scratch itself reveals the books underneath.
            if (scratch.isWin) {
                title.textContent = 'CONGRATULATIONS!';
                subtitle.textContent = 'You might have won a free book.';
                winContent.classList.remove('hidden');
                loseContent.classList.add('hidden');
                closeBtn.classList.remove('hidden');
            } else {
                title.textContent = 'Not This Time';
                subtitle.textContent = 'Spin the wheel for another chance.';
                loseContent.classList.remove('hidden');
                winContent.classList.add('hidden');
                closeBtn.classList.add('hidden');
            }

            modal.classList.remove('hidden');
        }

        function hideOutcome() {
            document.getElementById('outcomeModal').classList.add('hidden');
        }

        function restartScratch(keepOutcome = false) {
            // Reset outcome modal
            if (!keepOutcome) hideOutcome();

            // Re-show scratch game and hide wheel/thank you
            document.getElementById('scratchGame').classList.remove('hidden');
            document.getElementById('wheelGame').classList.add('hidden');
            document.getElementById('thankYou').classList.add('hidden');

            // Re-roll outcome
            scratch.isWin = Math.random() < 0.03;//probability of winning

            // Note: restart is only for resizing, we don't clear persistence here
            // because a resize shouldn't reset the game progress if they already won/lost.
            // If we wanted a full "Reset Game" button, we'd clear localStorage there.

            setupScratchSurface();
        }

        // Wheel
        function initWheel() {
            const wheel = document.getElementById('wheel');
            wheel.innerHTML = '';

            const colors = ['#fee600', '#00aee3'];
            const segments = 10;
            const angle = 360 / segments;

            for (let i = 0; i < segments; i++) {
                const seg = document.createElement('div');
                seg.className = 'wheel-segment';
                seg.style.transform = `rotate(${i * angle}deg)`;
                seg.style.background = colors[i % 2];
                seg.style.color = (i % 2 === 0) ? '#000' : '#fff';
                seg.style.fontSize = i === 0 ? '18px' : '14px';

                // Make segment text more readable
                seg.innerHTML = i === 0
                    ? '<span>WIN!</span>'
                    : '<span>TRY<br>AGAIN</span>';

                wheel.appendChild(seg);
            }

            document.getElementById('spinButton').addEventListener('click', spinWheel);

            // Make entire wheel clickable
            document.getElementById('wheel').addEventListener('click', spinWheel);
            document.querySelector('.center-circle').addEventListener('click', spinWheel);
        }

        function spinWheel() {
            const button = document.getElementById('spinButton');
            const wheel = document.getElementById('wheel');
            const resultDiv = document.getElementById('wheelResult');

            if (button.disabled) return; // Prevent double spin

            button.disabled = true;
            resultDiv.classList.add('hidden');
            resultDiv.innerHTML = '';
            button.textContent = 'Spinning...';

            // Save that we spun
            localStorage.setItem('tmlvm_wheel', JSON.stringify({ spun: true }));

            const isWin = Math.random() < 0.03;// probability of winning

            // Spin a lot + random
            let rotation = 3600 + Math.random() * 360;

            if (isWin) {
                // Align to the WIN segment roughly at the pointer
                // Our WIN segment starts at 0deg; pointer at 0deg.
                const currentAngle = rotation % 360;
                rotation += (360 - currentAngle) % 360;
            }

            wheel.style.transform = `rotate(${rotation}deg)`;

            setTimeout(() => {
                if (isWin) {
                    resultDiv.innerHTML = `
            <div class="bg-[var(--yellow)] text-black p-6 rounded-2xl font-bold text-lg sm:text-xl shadow-lg">
              You might have won! Code: <span class="font-black">827498</span><br>
              First 5 people to send the code will get a free book - <span class="font-black">francois.leborgne@gmail.com</span>.
            </div>
          `;
                } else {
                    resultDiv.innerHTML = `
            <div class="bg-gray-800 text-white p-6 rounded-2xl shadow-lg">
              <div class="font-black text-2xl mb-2">Almost Won!</div>
              <div class="text-lg opacity-90">Better luck next time!</div>
            </div>
          `;

                    setTimeout(() => {
                        document.getElementById('wheelGame').classList.add('hidden');
                        document.getElementById('thankYou').classList.remove('hidden');
                    }, 1400);
                }

                resultDiv.classList.remove('hidden');
                // button.disabled = false; // logic change: once spun, stayed disabled/move on
                button.textContent = 'Spin the Wheel!';
            }, 4000);
        }
    </script>
</body>

</html>