<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chronomètre de travail | Travailler moins, vivre mieux</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <style>
        * {
            font-family: 'Montserrat', sans-serif;
        }

        :root {
            --yellow: #fee600;
            --blue: #00aee3;
            --white: #ffffff;
        }

        body {
            background: linear-gradient(135deg, var(--blue) 0%, #0095c4 100%);
            min-height: 100vh;
        }

        .btn-play {
            background-color: var(--yellow);
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(254, 230, 0, 0.4);
        }

        .btn-play:hover {
            transform: scale(1.05);
            box-shadow: 0 12px 35px rgba(254, 230, 0, 0.5);
        }

        .btn-stop {
            background-color: var(--white);
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(255, 255, 255, 0.3);
        }

        .btn-stop:hover {
            transform: scale(1.05);
            box-shadow: 0 12px 35px rgba(255, 255, 255, 0.4);
        }

        .time-display {
            font-variant-numeric: tabular-nums;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }

        .pulse-animation {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.6;
            }
        }

        .session-item {
            border-left: 4px solid var(--yellow);
        }

        .modal-backdrop {
            backdrop-filter: blur(6px);
        }

        input[type="time"]::-webkit-calendar-picker-indicator {
            filter: invert(0.1);
            opacity: .7;
        }

        .clickable-time {
            cursor: pointer;
        }

        .clickable-time:hover {
            text-decoration: underline;
        }

        .return-home {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 50;
            color: white;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(4px);
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .return-home:hover {
            background: rgba(255, 255, 255, 0.4);
            transform: scale(1.1);
        }
    </style>
</head>

<body class="flex flex-col items-center justify-center p-4">
    <!-- Return Link -->
    <a href="index.html" class="return-home" title="Retour à l'accueil">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M19 12H5M12 19l-7-7 7-7" />
        </svg>
    </a>

    <div class="w-full max-w-md">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-white text-2xl font-bold mb-2">Travailler moins, vivre mieux</h1>
            <p class="text-white/80 font-light text-sm">Mesurez votre temps de travail</p>
        </div>

        <!-- Main Timer Card -->
        <div class="card rounded-3xl shadow-2xl p-8 mb-6">
            <!-- Status indicator -->
            <div class="flex items-center justify-center mb-6">
                <div id="statusDot" class="w-3 h-3 rounded-full bg-gray-300 mr-2"></div>
                <span id="statusText" class="text-gray-500 font-medium text-sm uppercase tracking-wider">En pause</span>
            </div>

            <!-- Current Session Timer -->
            <div class="text-center mb-8">
                <p class="text-gray-400 font-medium text-xs uppercase tracking-wider mb-2">Session en cours</p>
                <div id="currentTime" class="time-display text-6xl font-bold text-gray-800">
                    00:00:00
                </div>
            </div>

            <!-- Control Buttons -->
            <div class="flex justify-center gap-4 mb-8">
                <button id="playBtn" onclick="startTimer()"
                    class="btn-play w-20 h-20 rounded-full flex items-center justify-center">
                    <svg class="w-10 h-10 text-gray-800 ml-1" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M8 5v14l11-7z" />
                    </svg>
                </button>
                <button id="stopBtn" onclick="stopTimer()"
                    class="btn-stop w-20 h-20 rounded-full flex items-center justify-center" disabled
                    style="opacity: 0.5;">
                    <svg class="w-8 h-8 text-gray-800" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M6 6h12v12H6z" />
                    </svg>
                </button>
            </div>

            <!-- Today's Total -->
            <div class="bg-gradient-to-r from-[#00aee3] to-[#0095c4] rounded-2xl p-6 text-center">
                <p class="text-white/80 font-medium text-xs uppercase tracking-wider mb-1">Total aujourd'hui</p>
                <div id="totalTime" class="time-display text-4xl font-bold text-white">
                    00:00:00
                </div>
            </div>
        </div>

        <!-- Sessions History -->
        <div class="card rounded-3xl shadow-2xl p-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="font-bold text-gray-800">Sessions du jour</h2>
                <button onclick="clearSessions()"
                    class="text-xs text-gray-400 hover:text-red-500 font-medium transition-colors">
                    Effacer
                </button>
            </div>
            <div id="sessionsList" class="space-y-2 max-h-48 overflow-y-auto">
                <p class="text-gray-400 text-sm text-center py-4">Aucune session enregistrée</p>
            </div>
        </div>

        <!-- Weekly Summary -->
        <div class="card rounded-3xl shadow-2xl p-6 mt-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="font-bold text-gray-800">Semaine en cours</h2>
                <span id="weekRange" class="text-xs text-gray-400 font-medium"></span>
            </div>

            <div class="bg-gradient-to-r from-[#00aee3] to-[#0095c4] rounded-2xl p-5 text-center mb-4">
                <p class="text-white/80 font-medium text-xs uppercase tracking-wider mb-1">Total semaine</p>
                <div id="weeklyTotal" class="time-display text-3xl font-bold text-white">00:00:00</div>
            </div>

            <div id="weekDays" class="space-y-2"></div>
        </div>

        <!-- Footer -->
        <p class="text-center text-white/60 text-xs mt-6 font-light">
            Les données sont sauvegardées localement
        </p>
    </div>

    <!-- Edit Session Modal -->
    <div id="editModal" class="fixed inset-0 hidden items-center justify-center p-4 z-50">
        <div class="absolute inset-0 bg-black/40 modal-backdrop" onclick="closeEditModal()"></div>
        <div class="relative w-full max-w-md card rounded-3xl shadow-2xl p-6">
            <div class="flex items-start justify-between gap-4 mb-4">
                <div>
                    <h3 class="text-gray-800 font-extrabold text-lg">Modifier une session</h3>
                    <p class="text-gray-500 text-sm">Ajustez l’heure de début et de fin (format 24h).</p>
                </div>
                <button
                    class="w-10 h-10 rounded-full bg-gray-50 hover:bg-gray-100 text-gray-500 flex items-center justify-center"
                    onclick="closeEditModal()" aria-label="Fermer">
                    <span class="text-2xl leading-none">×</span>
                </button>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-4">
                <label class="block">
                    <span class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Début</span>
                    <input id="editStart" type="time"
                        class="mt-2 w-full rounded-xl border border-gray-200 bg-white px-4 py-3 text-gray-800 outline-none focus:ring-2 focus:ring-[#00aee3]/40" />
                </label>
                <label class="block">
                    <span class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Fin</span>
                    <input id="editEnd" type="time"
                        class="mt-2 w-full rounded-xl border border-gray-200 bg-white px-4 py-3 text-gray-800 outline-none focus:ring-2 focus:ring-[#00aee3]/40" />
                </label>
            </div>

            <div id="editHint" class="text-sm text-gray-500 mb-4"></div>

            <div class="flex items-center justify-between gap-3">
                <button onclick="deleteSessionFromModal()"
                    class="px-4 py-3 rounded-xl bg-red-50 text-red-600 font-semibold hover:bg-red-100 transition-colors">
                    Supprimer
                </button>
                <div class="flex items-center gap-3">
                    <button onclick="closeEditModal()"
                        class="px-4 py-3 rounded-xl bg-gray-100 text-gray-700 font-semibold hover:bg-gray-200 transition-colors">
                        Annuler
                    </button>
                    <button onclick="saveEditedSession()"
                        class="px-5 py-3 rounded-xl bg-[#fee600] text-gray-900 font-extrabold hover:brightness-95 transition-all shadow-[0_10px_25px_rgba(254,230,0,.35)]">
                        Enregistrer
                    </button>
                </div>
            </div>

            <div class="mt-4 text-xs text-gray-400">
                Astuce : si l’heure de fin est plus tôt que le début, la session sera comptée comme se terminant le
                lendemain.
            </div>
        </div>
    </div>

    <script>
        let isRunning = false;
        let startTime = null;
        let elapsedTime = 0;
        let timerInterval = null;


        // Date helpers
        function pad2(n) { return String(n).padStart(2, '0'); }
        function dateKeyFromDate(d) { return `timetracker_${d.getFullYear()}_${d.getMonth()}_${d.getDate()}`; }

        // Get today's date key for localStorage
        function getTodayKey() {
            return dateKeyFromDate(new Date());
        }

        // Week helpers (Monday-based)
        function getStartOfWeek(d) {
            const date = new Date(d);
            date.setHours(0, 0, 0, 0);
            const day = date.getDay(); // 0 Sun..6 Sat
            const diff = (day === 0 ? -6 : 1 - day); // move to Monday
            date.setDate(date.getDate() + diff);
            return date;
        }
        function getWeekRangeLabel(start) {
            const end = new Date(start);
            end.setDate(end.getDate() + 6);
            const fmt = (x) => `${pad2(x.getDate())}/${pad2(x.getMonth() + 1)}`;
            return `${fmt(start)} – ${fmt(end)}`;
        }

        // Load data from localStorage (for today)
        function loadData() {
            const key = getTodayKey();
            const data = localStorage.getItem(key);
            if (data) return JSON.parse(data);
            return { sessions: [], totalSeconds: 0 };
        }

        // Save data to localStorage (for today)
        function saveData(data) {
            const key = getTodayKey();
            localStorage.setItem(key, JSON.stringify(data));
        }

        // Load data for a specific day
        function loadDataForDate(d) {
            const key = dateKeyFromDate(d);
            const data = localStorage.getItem(key);
            if (data) return JSON.parse(data);
            return { sessions: [], totalSeconds: 0 };
        }

        // Save data for a specific day
        function saveDataForDate(d, data) {
            const key = dateKeyFromDate(d);
            localStorage.setItem(key, JSON.stringify(data));
        }

        // Check for running session on page load
        function checkRunningSession() {
            const runningSession = localStorage.getItem('timetracker_running');
            if (runningSession) {
                const session = JSON.parse(runningSession);
                startTime = session.startTime;
                isRunning = true;
                updateUI();
                timerInterval = setInterval(updateCurrentTime, 1000);
            }
        }

        // Format seconds to HH:MM:SS
        function formatTime(totalSeconds) {
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        // Update current session time display
        function updateCurrentTime() {
            if (isRunning && startTime) {
                const now = Date.now();
                const elapsed = Math.floor((now - startTime) / 1000);
                document.getElementById('currentTime').textContent = formatTime(elapsed);

                // Update total time (saved sessions + current)
                const data = loadData();
                document.getElementById('totalTime').textContent = formatTime(data.totalSeconds + elapsed);
            }
        }

        // Update UI based on state
        function updateUI() {
            const playBtn = document.getElementById('playBtn');
            const stopBtn = document.getElementById('stopBtn');
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');

            if (isRunning) {
                playBtn.disabled = true;
                playBtn.style.opacity = '0.5';
                stopBtn.disabled = false;
                stopBtn.style.opacity = '1';
                statusDot.className = 'w-3 h-3 rounded-full bg-green-500 mr-2 pulse-animation';
                statusText.textContent = 'En cours';
                statusText.className = 'text-green-600 font-semibold text-sm uppercase tracking-wider';
            } else {
                playBtn.disabled = false;
                playBtn.style.opacity = '1';
                stopBtn.disabled = true;
                stopBtn.style.opacity = '0.5';
                statusDot.className = 'w-3 h-3 rounded-full bg-gray-300 mr-2';
                statusText.textContent = 'En pause';
                statusText.className = 'text-gray-500 font-medium text-sm uppercase tracking-wider';
            }

            updateSessionsList();
        }

        // Start timer
        function startTimer() {
            if (isRunning) return;

            isRunning = true;
            startTime = Date.now();

            // Save running session
            localStorage.setItem('timetracker_running', JSON.stringify({
                startTime: startTime
            }));

            timerInterval = setInterval(updateCurrentTime, 1000);
            updateUI();
        }

        // Stop timer
        function stopTimer() {
            if (!isRunning) return;

            clearInterval(timerInterval);

            const now = Date.now();
            const sessionSeconds = Math.floor((now - startTime) / 1000);

            if (sessionSeconds > 0) {
                // Save session
                const data = loadData();
                const session = {
                    start: startTime,
                    end: now,
                    duration: sessionSeconds
                };
                data.sessions.push(session);
                data.totalSeconds += sessionSeconds;
                saveData(data);
            }

            // Clear running session
            localStorage.removeItem('timetracker_running');

            isRunning = false;
            startTime = null;
            document.getElementById('currentTime').textContent = '00:00:00';

            updateUI();
            updateTotalTime();
            updateWeeklySummary();
        }

        // Update total time display
        function updateTotalTime() {
            const data = loadData();
            document.getElementById('totalTime').textContent = formatTime(data.totalSeconds);
        }

        function updateWeeklySummary() {
            const start = getStartOfWeek(new Date());
            const weekRangeEl = document.getElementById('weekRange');
            const weeklyTotalEl = document.getElementById('weeklyTotal');
            const weekDaysEl = document.getElementById('weekDays');
            if (!weekRangeEl || !weeklyTotalEl || !weekDaysEl) return;

            weekRangeEl.textContent = getWeekRangeLabel(start);

            const dayLabels = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];
            let weeklySeconds = 0;
            const rows = [];

            for (let i = 0; i < 7; i++) {
                const d = new Date(start);
                d.setDate(d.getDate() + i);
                const data = loadDataForDate(d);
                const seconds = data.totalSeconds || 0;
                weeklySeconds += seconds;

                const isToday = (new Date()).toDateString() === d.toDateString();
                const dateStr = `${pad2(d.getDate())}/${pad2(d.getMonth() + 1)}`;

                rows.push(`
                    <div class="flex items-center justify-between bg-gray-50 rounded-xl px-4 py-3 ${isToday ? 'ring-2 ring-[#fee600]/70' : ''}">
                        <div class="flex items-center gap-3">
                            <div class="w-10 text-gray-700 font-semibold">${dayLabels[i]}</div>
                            <div class="text-xs text-gray-400">${dateStr}</div>
                        </div>
                        <div class="time-display text-gray-800 font-bold">${formatTime(seconds)}</div>
                    </div>
                `);
            }

            weeklyTotalEl.textContent = formatTime(weeklySeconds);
            weekDaysEl.innerHTML = rows.join('');
        }

        // Modal edit state
        let editingSessionIndex = null; // index in data.sessions

        function secondsSinceMidnight(d) {
            return d.getHours() * 3600 + d.getMinutes() * 60 + d.getSeconds();
        }

        function hhmmFromDate(d) {
            return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
        }

        function parseHHMM(str) {
            const m = /^([01]\d|2[0-3]):([0-5]\d)$/.exec(String(str || '').trim());
            if (!m) return null;
            return { h: parseInt(m[1], 10), min: parseInt(m[2], 10) };
        }

        function computeDurationSecondsFromTimes(startHHMM, endHHMM) {
            const s = parseHHMM(startHHMM);
            const e = parseHHMM(endHHMM);
            if (!s || !e) return null;
            const startSec = s.h * 3600 + s.min * 60;
            const endSec = e.h * 3600 + e.min * 60;
            let dur = endSec - startSec;
            if (dur < 0) dur += 24 * 3600; // crosses midnight
            return dur;
        }

        function openEditModal(index) {
            const data = loadData();
            const session = data.sessions[index];
            if (!session) return;
            if (isRunning) {
                alert('Stoppez le chronomètre avant de modifier les sessions.');
                return;
            }

            editingSessionIndex = index;

            const startDate = new Date(session.start);
            const endDate = new Date(session.end);

            document.getElementById('editStart').value = hhmmFromDate(startDate);
            document.getElementById('editEnd').value = hhmmFromDate(endDate);

            const hintEl = document.getElementById('editHint');
            const dateStr = `${pad2(startDate.getDate())}/${pad2(startDate.getMonth() + 1)}/${startDate.getFullYear()}`;
            hintEl.textContent = `Session du ${dateStr} · Durée actuelle : ${formatTime(session.duration || 0)}`;

            const modal = document.getElementById('editModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');

            // focus
            setTimeout(() => document.getElementById('editStart').focus(), 50);
        }

        function closeEditModal() {
            const modal = document.getElementById('editModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            editingSessionIndex = null;
        }

        function recomputeDayTotal(data) {
            data.totalSeconds = (data.sessions || []).reduce((acc, s) => acc + (s.duration || 0), 0);
        }

        function saveEditedSession() {
            if (editingSessionIndex === null) return;
            const data = loadData();
            const session = data.sessions[editingSessionIndex];
            if (!session) return;

            const startVal = document.getElementById('editStart').value;
            const endVal = document.getElementById('editEnd').value;
            const newDur = computeDurationSecondsFromTimes(startVal, endVal);

            if (newDur === null) {
                alert('Veuillez saisir des heures valides (HH:MM).');
                return;
            }
            if (newDur === 0) {
                alert('La durée ne peut pas être 00:00.');
                return;
            }

            // Build new timestamps while preserving the session's original date as the base.
            const base = new Date(session.start);
            base.setSeconds(0, 0);

            const s = parseHHMM(startVal);
            const e = parseHHMM(endVal);

            const startDate = new Date(base);
            startDate.setHours(s.h, s.min, 0, 0);

            const endDate = new Date(base);
            endDate.setHours(e.h, e.min, 0, 0);
            if (endDate.getTime() <= startDate.getTime()) {
                endDate.setDate(endDate.getDate() + 1);
            }

            session.start = startDate.getTime();
            session.end = endDate.getTime();
            session.duration = Math.floor((session.end - session.start) / 1000);

            recomputeDayTotal(data);
            saveData(data);

            closeEditModal();
            updateTotalTime();
            updateSessionsList();
            updateWeeklySummary();
        }

        function deleteSessionFromModal() {
            if (editingSessionIndex === null) return;
            deleteSession(editingSessionIndex);
            closeEditModal();
        }

        // Update sessions list
        function deleteSession(index) {
            // index refers to the original order in data.sessions
            if (!confirm('Supprimer cette session ?')) return;
            const data = loadData();
            if (!data.sessions[index]) return;
            data.sessions.splice(index, 1);
            recomputeDayTotal(data);
            saveData(data);
            updateTotalTime();
            updateSessionsList();
            updateWeeklySummary();
        }

        // Update sessions list
        function updateSessionsList() {
            const data = loadData();
            const container = document.getElementById('sessionsList');

            if (data.sessions.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-sm text-center py-4">Aucune session enregistrée</p>';
                return;
            }

            // Show newest first, but keep ability to target correct entry
            const items = data.sessions.map((session, index) => ({ session, index })).reverse();

            container.innerHTML = items.map(({ session, index }) => {
                const startDate = new Date(session.start);
                const endDate = new Date(session.end);
                const startStr = startDate.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
                const endStr = endDate.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });

                return `
                    <div class="session-item bg-gray-50 rounded-lg p-3 pl-4">
                        <div class="flex justify-between items-center gap-3">
                            <div class="min-w-0">
                                <button onclick="openEditModal(${index})" class="clickable-time text-left text-gray-600 text-sm font-semibold truncate w-full" title="Cliquer pour modifier">
                                    ${startStr} - ${endStr}
                                </button>
                                <div class="text-gray-400 text-xs">${formatTime(session.duration)}</div>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-gray-800 font-bold text-sm whitespace-nowrap">${formatTime(session.duration)}</span>
                                <button onclick="deleteSession(${index})" class="w-8 h-8 rounded-full bg-white hover:bg-red-50 text-gray-400 hover:text-red-600 transition-colors flex items-center justify-center" aria-label="Supprimer">
                                    <span class="text-lg leading-none">×</span>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Clear all sessions
        function clearSessions() {
            if (confirm('Effacer toutes les sessions du jour ?')) {
                if (isRunning) {
                    stopTimer();
                }
                const key = getTodayKey();
                localStorage.removeItem(key);
                localStorage.removeItem('timetracker_running');
                document.getElementById('currentTime').textContent = '00:00:00';
                updateTotalTime();
                updateSessionsList();
                updateWeeklySummary();
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            checkRunningSession();
            updateTotalTime();
            updateSessionsList();
            updateWeeklySummary();
            updateUI();

            // Close modal with Escape
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') closeEditModal();
            });
        });
    </script>
</body>

</html>