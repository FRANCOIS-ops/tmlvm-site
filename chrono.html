<!DOCTYPE html>
<html lang="fr">

<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-0BR9V0WPVZ"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-0BR9V0WPVZ');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chronomètre de travail | Travailler moins, vivre mieux</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <style>
        * {
            font-family: 'Montserrat', sans-serif;
        }

        :root {
            --yellow: #fee600;
            --blue: #00aee3;
            --white: #ffffff;
        }

        body {
            background: linear-gradient(135deg, var(--blue) 0%, #0095c4 100%);
            min-height: 100vh;
        }

        .btn-play {
            background-color: var(--yellow);
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(254, 230, 0, 0.4);
        }

        .btn-play:hover {
            transform: scale(1.05);
            box-shadow: 0 12px 35px rgba(254, 230, 0, 0.5);
        }

        .btn-stop {
            background-color: var(--white);
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(255, 255, 255, 0.3);
        }

        .btn-stop:hover {
            transform: scale(1.05);
            box-shadow: 0 12px 35px rgba(255, 255, 255, 0.4);
        }

        .time-display {
            font-variant-numeric: tabular-nums;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }

        .pulse-animation {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.6;
            }
        }

        .session-item {
            border-left: 4px solid var(--yellow);
        }

        .modal-backdrop {
            backdrop-filter: blur(6px);
        }

        input[type="time"]::-webkit-calendar-picker-indicator {
            filter: invert(0.1);
            opacity: .7;
        }

        .clickable-time {
            cursor: pointer;
        }

        .clickable-time:hover {
            text-decoration: underline;
        }

        .weekly-day-row:hover {
            background-color: #f3f4f6;
            cursor: pointer;
        }

        .return-home {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 50;
            color: white;
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(4px);
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .return-home:hover {
            background: rgba(255, 255, 255, 0.4);
            transform: scale(1.1);
        }
    </style>
</head>

<body class="flex flex-col items-center justify-center p-4">
    <!-- Return Link -->
    <a href="index.html" class="return-home" title="Retour à l'accueil">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M19 12H5M12 19l-7-7 7-7" />
        </svg>
    </a>


    <div class="w-full max-w-md relative">
        <!-- Language Toggles -->
        <div class="flex justify-end gap-2 mb-2">
            <button onclick="setLanguage('fr')" id="btn-fr"
                class="text-xs font-bold uppercase py-1 px-2 rounded hover:bg-white/20 text-white transition-colors border border-white/20"
                title="Français">FR</button>
            <button onclick="setLanguage('en')" id="btn-en"
                class="text-xs font-bold uppercase py-1 px-2 rounded hover:bg-white/20 text-white transition-colors border border-white/20 opacity-50"
                title="English">EN</button>
        </div>
        <!-- Header -->
        <div class="text-center mb-4">
            <h1 class="text-white text-2xl font-bold mb-2" data-i18n="title">Travailler moins, vivre mieux</h1>
            <p class="text-white/80 font-light text-sm" data-i18n="subtitle">Mesurez votre temps de travail</p>
        </div>

        <!-- Reset Week Button -->
        <div class="text-center mb-4">
            <button onclick="resetWeek()"
                class="bg-white/20 hover:bg-white/30 text-white text-xs font-medium py-2 px-4 rounded-full transition-colors"
                data-i18n="resetWeek">
                Réinitialiser semaine
            </button>
        </div>

        <!-- Main Timer Card -->
        <div class="card rounded-3xl shadow-2xl p-8 mb-6">
            <!-- Author's Note: Status text is handled dynamically in JS but we can add default i18n -->
            <div class="flex items-center justify-center mb-6">
                <div id="statusDot" class="w-3 h-3 rounded-full bg-gray-300 mr-2"></div>
                <span id="statusText" class="text-gray-500 font-medium text-sm uppercase tracking-wider"
                    data-i18n="statusPause">En pause</span>
            </div>

            <!-- Current Session Timer -->
            <div class="text-center mb-8">
                <p class="text-gray-400 font-medium text-xs uppercase tracking-wider mb-2" data-i18n="sessionCurrent">
                    Session en cours</p>
                <div id="currentTime" class="time-display text-6xl font-bold text-gray-800">
                    00:00:00
                </div>
                <button id="currentStart" onclick="openRunningStartModal()"
                    class="mt-3 inline-flex items-center justify-center gap-2 text-xs font-semibold text-gray-500 hover:text-gray-800 transition-colors clickable-time"
                    title="Cliquer pour modifier l’heure de départ">
                    <span class="text-gray-400" data-i18n="startLabel">Début :</span>
                    <span id="currentStartLabel" class="time-display">–</span>
                </button>
            </div>

            <!-- Control Buttons -->
            <div class="flex justify-center gap-4 mb-8">
                <button id="playBtn" onclick="startTimer()"
                    class="btn-play w-20 h-20 rounded-full flex items-center justify-center">
                    <svg class="w-10 h-10 text-gray-800 ml-1" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M8 5v14l11-7z" />
                    </svg>
                </button>
                <button id="stopBtn" onclick="stopTimer()"
                    class="btn-stop w-20 h-20 rounded-full flex items-center justify-center" disabled
                    style="opacity: 0.5;">
                    <svg class="w-8 h-8 text-gray-800" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M6 6h12v12H6z" />
                    </svg>
                </button>
            </div>

            <!-- Today's Total -->
            <div class="bg-gradient-to-r from-[#00aee3] to-[#0095c4] rounded-2xl p-6 text-center">
                <p class="text-white/80 font-medium text-xs uppercase tracking-wider mb-1" data-i18n="totalToday">Total
                    aujourd'hui</p>
                <div id="totalTime" class="time-display text-4xl font-bold text-white">
                    00:00:00
                </div>
            </div>
        </div>

        <!-- Sessions History -->
        <div class="card rounded-3xl shadow-2xl p-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="font-bold text-gray-800" data-i18n="sessionsToday">Sessions du jour</h2>
                <button onclick="clearSessions()"
                    class="text-xs text-gray-400 hover:text-red-500 font-medium transition-colors" data-i18n="clear">
                    Effacer
                </button>
            </div>
            <div id="sessionsList" class="space-y-2 max-h-48 overflow-y-auto">
                <p class="text-gray-400 text-sm text-center py-4">Aucune session enregistrée</p>
            </div>
        </div>

        <!-- Weekly Summary -->
        <div class="card rounded-3xl shadow-2xl p-6 mt-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="font-bold text-gray-800" data-i18n="weekCurrent">Semaine en cours</h2>
                <span id="weekRange" class="text-xs text-gray-400 font-medium"></span>
            </div>

            <div class="bg-gradient-to-r from-[#00aee3] to-[#0095c4] rounded-2xl p-5 text-center mb-4">
                <p class="text-white/80 font-medium text-xs uppercase tracking-wider mb-1" data-i18n="totalWeek">Total
                    semaine</p>
                <div class="flex items-center justify-center gap-2">
                    <div id="weeklyTotal" class="time-display text-3xl font-bold text-white">00:00:00</div>
                    <span id="weeklyDanger" class="hidden text-2xl" title="Dépassement de 50h hebdomadaires">⚠</span>
                </div>
            </div>

            <div id="weekDays" class="space-y-2"></div>
        </div>

        <!-- Footer -->
        <p class="text-center text-white/60 text-xs mt-6 font-light" data-i18n="savedLocally">
            Les données sont sauvegardées localement
        </p>
    </div>

    <!-- Edit Session Modal -->
    <div id="editModal" class="fixed inset-0 hidden items-center justify-center p-4 z-50">
        <div class="absolute inset-0 bg-black/40 modal-backdrop" onclick="closeEditModal()"></div>
        <div class="relative w-full max-w-md card rounded-3xl shadow-2xl p-6">
            <div class="flex items-start justify-between gap-4 mb-4">
                <div>
                    <h3 class="text-gray-800 font-extrabold text-lg" data-i18n="modalEditTitle">Modifier une session
                    </h3>
                    <p class="text-gray-500 text-sm" data-i18n="modalEditDesc">Ajustez l’heure de début et de fin
                        (format 24h).</p>
                </div>
                <button
                    class="w-10 h-10 rounded-full bg-gray-50 hover:bg-gray-100 text-gray-500 flex items-center justify-center"
                    onclick="closeEditModal()" aria-label="Fermer">
                    <span class="text-2xl leading-none">×</span>
                </button>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-4">
                <label class="block">
                    <span class="text-xs font-semibold text-gray-500 uppercase tracking-wider"
                        data-i18n="labelStart">Début</span>
                    <input id="editStart" type="time"
                        class="mt-2 w-full rounded-xl border border-gray-200 bg-white px-4 py-3 text-gray-800 outline-none focus:ring-2 focus:ring-[#00aee3]/40" />
                </label>
                <label class="block">
                    <span class="text-xs font-semibold text-gray-500 uppercase tracking-wider"
                        data-i18n="labelEnd">Fin</span>
                    <input id="editEnd" type="time"
                        class="mt-2 w-full rounded-xl border border-gray-200 bg-white px-4 py-3 text-gray-800 outline-none focus:ring-2 focus:ring-[#00aee3]/40" />
                </label>
            </div>

            <div id="editHint" class="text-sm text-gray-500 mb-4"></div>

            <div class="flex items-center justify-between gap-3">
                <button onclick="deleteSessionFromModal()"
                    class="px-4 py-3 rounded-xl bg-red-50 text-red-600 font-semibold hover:bg-red-100 transition-colors"
                    data-i18n="btnDelete">
                    Supprimer
                </button>
                <div class="flex items-center gap-3">
                    <button onclick="closeEditModal()"
                        class="px-4 py-3 rounded-xl bg-gray-100 text-gray-700 font-semibold hover:bg-gray-200 transition-colors"
                        data-i18n="btnCancel">
                        Annuler
                    </button>
                    <button onclick="saveEditedSession()"
                        class="px-5 py-3 rounded-xl bg-[#fee600] text-gray-900 font-extrabold hover:brightness-95 transition-all shadow-[0_10px_25px_rgba(254,230,0,.35)]"
                        data-i18n="btnSave">
                        Enregistrer
                    </button>
                </div>
            </div>

            <div class="mt-4 text-xs text-gray-400" data-i18n="hintNextDay">
                Astuce : si l’heure de fin est plus tôt que le début, la session sera comptée comme se terminant le
                lendemain.
            </div>
        </div>
    </div>

    <!-- Edit Running Session Start Modal -->
    <div id="runningStartModal" class="fixed inset-0 hidden items-center justify-center p-4 z-50">
        <div class="absolute inset-0 bg-black/40 modal-backdrop" onclick="closeRunningStartModal()"></div>
        <div class="relative w-full max-w-md card rounded-3xl shadow-2xl p-6">
            <div class="flex items-start justify-between gap-4 mb-4">
                <div>
                    <h3 class="text-gray-800 font-extrabold text-lg" data-i18n="modalStartTitle">Modifier le départ</h3>
                    <p class="text-gray-500 text-sm" data-i18n="modalStartDesc">Changez la date et l’heure de départ de
                        la session en cours.</p>
                </div>
                <button
                    class="w-10 h-10 rounded-full bg-gray-50 hover:bg-gray-100 text-gray-500 flex items-center justify-center"
                    onclick="closeRunningStartModal()" aria-label="Fermer">
                    <span class="text-2xl leading-none">×</span>
                </button>
            </div>

            <label class="block mb-4">
                <span class="text-xs font-semibold text-gray-500 uppercase tracking-wider"
                    data-i18n="labelStartDateTime">Départ (date + heure)</span>
                <input id="runningStartInput" type="datetime-local"
                    class="mt-2 w-full rounded-xl border border-gray-200 bg-white px-4 py-3 text-gray-800 outline-none focus:ring-2 focus:ring-[#00aee3]/40" />
            </label>

            <div id="runningStartHint" class="text-sm text-gray-500 mb-4"></div>

            <div class="flex items-center justify-end gap-3">
                <button onclick="closeRunningStartModal()"
                    class="px-4 py-3 rounded-xl bg-gray-100 text-gray-700 font-semibold hover:bg-gray-200 transition-colors"
                    data-i18n="btnCancel">
                    Annuler
                </button>
                <button onclick="saveRunningStart()"
                    class="px-5 py-3 rounded-xl bg-[#fee600] text-gray-900 font-extrabold hover:brightness-95 transition-all shadow-[0_10px_25px_rgba(254,230,0,.35)]"
                    data-i18n="btnSave">
                    Enregistrer
                </button>
            </div>

            <div class="mt-4 text-xs text-gray-400" data-i18n="hintForgot">
                Astuce : vous pouvez corriger un oubli (ex: vous avez démarré le chrono en retard).
            </div>
        </div>
    </div>

    <!-- Override Day Total Modal -->
    <div id="overrideModal" class="fixed inset-0 hidden items-center justify-center p-4 z-50">
        <div class="absolute inset-0 bg-black/40 modal-backdrop" onclick="closeOverrideModal()"></div>
        <div class="relative w-full max-w-md card rounded-3xl shadow-2xl p-6">
            <div class="flex items-start justify-between gap-4 mb-4">
                <div>
                    <h3 class="text-gray-800 font-extrabold text-lg" data-i18n="modalOverrideTitle">Modifier le total du
                        jour</h3>
                    <p id="overrideDayLabel" class="text-gray-500 text-sm" data-i18n="modalOverrideDesc">Saisissez le
                        temps total pour ce jour.</p>
                </div>
                <button
                    class="w-10 h-10 rounded-full bg-gray-50 hover:bg-gray-100 text-gray-500 flex items-center justify-center"
                    onclick="closeOverrideModal()" aria-label="Fermer">
                    <span class="text-2xl leading-none">×</span>
                </button>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-4">
                <label class="block">
                    <span class="text-xs font-semibold text-gray-500 uppercase tracking-wider"
                        data-i18n="labelHours">Heures</span>
                    <input id="overrideHours" type="number" min="0" max="23"
                        class="mt-2 w-full rounded-xl border border-gray-200 bg-white px-4 py-3 text-gray-800 outline-none focus:ring-2 focus:ring-[#00aee3]/40"
                        placeholder="0" />
                </label>
                <label class="block">
                    <span class="text-xs font-semibold text-gray-500 uppercase tracking-wider"
                        data-i18n="labelMinutes">Minutes</span>
                    <input id="overrideMinutes" type="number" min="0" max="59"
                        class="mt-2 w-full rounded-xl border border-gray-200 bg-white px-4 py-3 text-gray-800 outline-none focus:ring-2 focus:ring-[#00aee3]/40"
                        placeholder="0" />
                </label>
            </div>

            <div class="flex items-center justify-end gap-3">
                <button onclick="closeOverrideModal()"
                    class="px-4 py-3 rounded-xl bg-gray-100 text-gray-700 font-semibold hover:bg-gray-200 transition-colors"
                    data-i18n="btnCancel">
                    Annuler
                </button>
                <button onclick="saveOverride()"
                    class="px-5 py-3 rounded-xl bg-[#fee600] text-gray-900 font-extrabold hover:brightness-95 transition-all shadow-[0_10px_25px_rgba(254,230,0,.35)]"
                    data-i18n="btnSave">
                    Enregistrer
                </button>
            </div>

            <div class="mt-4 text-xs text-red-400" data-i18n="hintOverrideWarn">
                Attention : écraser le total supprimera l'historique des sessions pour cette journée.
            </div>
        </div>
    </div>

    <script>
        let isRunning = false;
        let startTime = null;
        let elapsedTime = 0;
        let timerInterval = null;
        let currentLang = 'fr';

        const DICTIONARY = {
            fr: {
                title: "Travailler moins, vivre mieux",
                subtitle: "Mesurez votre temps de travail",
                resetWeek: "Réinitialiser semaine",
                statusPause: "En pause",
                statusRunning: "En cours",
                sessionCurrent: "Session en cours",
                startLabel: "Début :",
                totalToday: "Total aujourd'hui",
                sessionsToday: "Sessions du jour",
                clear: "Effacer",
                noSessions: "Aucune session enregistrée",
                weekCurrent: "Semaine en cours",
                totalWeek: "Total semaine",
                savedLocally: "Les données sont sauvegardées localement",
                modalEditTitle: "Modifier une session",
                modalEditDesc: "Ajustez l’heure de début et de fin (format 24h).",
                labelStart: "Début",
                labelEnd: "Fin",
                btnDelete: "Supprimer",
                btnCancel: "Annuler",
                btnSave: "Enregistrer",
                hintNextDay: "Astuce : si l’heure de fin est plus tôt que le début, la session sera comptée comme se terminant le lendemain.",
                modalStartTitle: "Modifier le départ",
                modalStartDesc: "Changez la date et l’heure de départ de la session en cours.",
                labelStartDateTime: "Départ (date + heure)",
                hintForgot: "Astuce : vous pouvez corriger un oubli (ex: vous avez démarré le chrono en retard).",
                modalOverrideTitle: "Modifier le total du jour",
                modalOverrideDesc: "Saisissez le temps total pour ce jour (écrasera l'historique).",
                labelHours: "Heures",
                labelMinutes: "Minutes",
                hintOverrideWarn: "Attention : écraser le total supprimera l'historique des sessions pour cette journée.",
                confirmReset: "Effacer toutes les données de la semaine ?",
                alertReset: "Semaine réinitialisée.",
                confirmDelete: "Supprimer cette session ?",
                confirmClearDay: "Effacer toutes les sessions du jour ?",
                alertStopFirst: "Stoppez le chronomètre avant de modifier les sessions.",
                alertInvalidTime: "Veuillez saisir des heures valides (HH:MM).",
                alertZeroDuration: "La durée ne peut pas être 00:00.",
                alertInvalidDate: "Date invalide",
                days: ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim']
            },
            en: {
                title: "Work Less, Live Better",
                subtitle: "Track your working time",
                resetWeek: "Reset Week",
                statusPause: "Paused",
                statusRunning: "Running",
                sessionCurrent: "Current Session",
                startLabel: "Start:",
                totalToday: "Total Today",
                sessionsToday: "Today's Sessions",
                clear: "Clear",
                noSessions: "No sessions recorded",
                weekCurrent: "Current Week",
                totalWeek: "Total Week",
                savedLocally: "Data is saved locally",
                modalEditTitle: "Edit Session",
                modalEditDesc: "Adjust start and end times (24h format).",
                labelStart: "Start",
                labelEnd: "End",
                btnDelete: "Delete",
                btnCancel: "Cancel",
                btnSave: "Save",
                hintNextDay: "Tip: if end time is earlier than start time, session counts as ending the next day.",
                modalStartTitle: "Edit Start Time",
                modalStartDesc: "Change the start date and time of the current session.",
                labelStartDateTime: "Start (Date + Time)",
                hintForgot: "Tip: fix a forgotten start (e.g., started working earlier).",
                modalOverrideTitle: "Edit Daily Total",
                modalOverrideDesc: "Enter total time for this day (overwrites history).",
                labelHours: "Hours",
                labelMinutes: "Minutes",
                hintOverrideWarn: "Warning: overriding total will clear session history for this day.",
                confirmReset: "Clear all data for the week?",
                alertReset: "Week reset.",
                confirmDelete: "Delete this session?",
                confirmClearDay: "Clear all sessions for today?",
                alertStopFirst: "Stop the timer before editing sessions.",
                alertInvalidTime: "Please enter valid times (HH:MM).",
                alertZeroDuration: "Duration cannot be 00:00.",
                alertInvalidDate: "Invalid Date",
                days: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun']
            }
        };

        function setLanguage(lang) {
            if (!DICTIONARY[lang]) return;
            currentLang = lang;
            localStorage.setItem('timetracker_lang', lang);

            // Update Toggles
            document.getElementById('btn-fr').style.opacity = lang === 'fr' ? '1' : '0.5';
            document.getElementById('btn-en').style.opacity = lang === 'en' ? '1' : '0.5';

            // Update Texts
            const dict = DICTIONARY[lang];
            const elements = document.querySelectorAll('[data-i18n]');
            elements.forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (dict[key]) {
                    if (el.tagName === 'INPUT' && el.getAttribute('placeholder')) {
                        el.setAttribute('placeholder', dict[key]);
                    } else {
                        el.textContent = dict[key];
                    }
                }
            });

            // Update Dynamic UI
            updateUI(); // Updates status text
            updateSessionsList(); // Updates list text (if empty)
            updateWeeklySummary(); // Updates days
            updateCurrentTime(); // Updates dynamic start label
        }

        function initLanguage() {
            const saved = localStorage.getItem('timetracker_lang');
            setLanguage(saved || 'fr');
        }


        // Date helpers
        function pad2(n) { return String(n).padStart(2, '0'); }
        function dateKeyFromDate(d) { return `timetracker_${d.getFullYear()}_${d.getMonth()}_${d.getDate()}`; }

        // Get today's date key for localStorage
        function getTodayKey() {
            return dateKeyFromDate(new Date());
        }

        // Week helpers (Monday-based)
        function getStartOfWeek(d) {
            const date = new Date(d);
            date.setHours(0, 0, 0, 0);
            const day = date.getDay(); // 0 Sun..6 Sat
            const diff = (day === 0 ? -6 : 1 - day); // move to Monday
            date.setDate(date.getDate() + diff);
            return date;
        }
        function getWeekRangeLabel(start) {
            const end = new Date(start);
            end.setDate(end.getDate() + 6);
            const fmt = (x) => `${pad2(x.getDate())}/${pad2(x.getMonth() + 1)}`;
            return `${fmt(start)} – ${fmt(end)}`;
        }

        // Reset entire week data
        function resetWeek() {
            if (!confirm(DICTIONARY[currentLang].confirmReset)) return;
            const start = getStartOfWeek(new Date());
            for (let i = 0; i < 7; i++) {
                const d = new Date(start);
                d.setDate(d.getDate() + i);
                const key = dateKeyFromDate(d);
                localStorage.removeItem(key);
            }
            localStorage.removeItem('timetracker_running');
            isRunning = false;
            startTime = null;
            updateTotalTime();
            updateSessionsList();
            updateWeeklySummary();
            document.getElementById('currentTime').textContent = '00:00:00';
            alert(DICTIONARY[currentLang].alertReset);
        }

        // Load data from localStorage (for today)
        function loadData() {
            const key = getTodayKey();
            const data = localStorage.getItem(key);
            if (data) return JSON.parse(data);
            return { sessions: [], totalSeconds: 0 };
        }

        // Save data to localStorage (for today)
        function saveData(data) {
            const key = getTodayKey();
            localStorage.setItem(key, JSON.stringify(data));
        }

        // Load data for a specific day
        function loadDataForDate(d) {
            const key = dateKeyFromDate(d);
            const data = localStorage.getItem(key);
            if (data) return JSON.parse(data);
            return { sessions: [], totalSeconds: 0 };
        }

        // Save data for a specific day
        function saveDataForDate(d, data) {
            const key = dateKeyFromDate(d);
            localStorage.setItem(key, JSON.stringify(data));
        }

        // Check for running session on page load
        function checkRunningSession() {
            const runningSession = localStorage.getItem('timetracker_running');
            if (runningSession) {
                const session = JSON.parse(runningSession);
                startTime = session.startTime;
                isRunning = true;
                updateUI();
                timerInterval = setInterval(updateCurrentTime, 1000);
                // Mettre à jour l'affichage du début de session immédiatement
                updateCurrentTime();
            }
        }

        // Format seconds to HH:MM:SS
        function formatTime(totalSeconds) {
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        // Update current session time display
        function updateCurrentTime() {
            if (isRunning && startTime) {
                const now = Date.now();
                const elapsed = Math.floor((now - startTime) / 1000);
                document.getElementById('currentTime').textContent = formatTime(elapsed);

                // Mettre à jour l'affichage du début de session
                const startDate = new Date(startTime);
                document.getElementById('currentStartLabel').textContent =
                    `${pad2(startDate.getDate())}/${pad2(startDate.getMonth() + 1)} ${pad2(startDate.getHours())}:${pad2(startDate.getMinutes())}`;

                // Update total time (saved sessions + current)
                const data = loadData();
                document.getElementById('totalTime').textContent = formatTime(data.totalSeconds + elapsed);
            }
        }

        // Get color code based on total hours
        function getColorCode(hours) {
            if (hours >= 10) return '#ff0000'; // rouge si > 10h
            if (hours >= 8) return '#ffa500';  // orange si > 8h
            if (hours > 0) return '#10b981';   // vert (emerald-500) sinon
            return '#6B7280'; // gris si 0
        }

        // Get weekly color code
        function getWeeklyColorCode(hours) {
            if (hours >= 50) return '#ff0000'; // rouge si > 50h
            if (hours >= 40) return '#ffa500'; // orange si > 40h
            if (hours > 0) return '#10b981';   // vert sinon
            return '#6B7280';
        }

        // Update UI based on state
        function updateUI() {
            const playBtn = document.getElementById('playBtn');
            const stopBtn = document.getElementById('stopBtn');
            const statusDot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');

            if (isRunning) {
                playBtn.disabled = true;
                playBtn.style.opacity = '0.5';
                stopBtn.disabled = false;
                stopBtn.style.opacity = '1';
                statusDot.className = 'w-3 h-3 rounded-full bg-green-500 mr-2 pulse-animation';
                statusText.textContent = DICTIONARY[currentLang].statusRunning;
                statusText.className = 'text-green-600 font-semibold text-sm uppercase tracking-wider';
            } else {
                playBtn.disabled = false;
                playBtn.style.opacity = '1';
                stopBtn.disabled = true;
                stopBtn.style.opacity = '0.5';
                statusDot.className = 'w-3 h-3 rounded-full bg-gray-300 mr-2';
                statusText.textContent = DICTIONARY[currentLang].statusPause;
                statusText.className = 'text-gray-500 font-medium text-sm uppercase tracking-wider';
                document.getElementById('currentStartLabel').textContent = '–';
            }

            updateSessionsList();
        }

        // Start timer
        function startTimer() {
            if (isRunning) return;

            isRunning = true;
            startTime = Date.now();

            // Save running session
            localStorage.setItem('timetracker_running', JSON.stringify({
                startTime: startTime
            }));

            timerInterval = setInterval(updateCurrentTime, 1000);
            updateCurrentTime();
            updateUI();
        }

        // Stop timer
        function stopTimer() {
            if (!isRunning) return;

            clearInterval(timerInterval);

            const now = Date.now();
            const sessionSeconds = Math.floor((now - startTime) / 1000);

            if (sessionSeconds > 0) {
                // Save session
                const data = loadData();
                const session = {
                    start: startTime,
                    end: now,
                    duration: sessionSeconds
                };
                data.sessions.push(session);
                data.totalSeconds += sessionSeconds;
                saveData(data);
            }

            // Clear running session
            localStorage.removeItem('timetracker_running');

            isRunning = false;
            startTime = null;
            document.getElementById('currentTime').textContent = '00:00:00';

            updateUI();
            updateTotalTime();
            updateWeeklySummary();
        }

        // Update total time display
        function updateTotalTime() {
            const data = loadData();
            const totalSeconds = data.totalSeconds || 0;
            const hours = totalSeconds / 3600;
            const color = getColorCode(hours);
            document.getElementById('totalTime').textContent = formatTime(totalSeconds);
            document.getElementById('totalTime').style.color = color;
        }

        function updateWeeklySummary() {
            const start = getStartOfWeek(new Date());
            const weekRangeEl = document.getElementById('weekRange');
            const weeklyTotalEl = document.getElementById('weeklyTotal');
            const weekDaysEl = document.getElementById('weekDays');
            const weeklyDangerEl = document.getElementById('weeklyDanger');
            if (!weekRangeEl || !weeklyTotalEl || !weekDaysEl) return;

            weekRangeEl.textContent = getWeekRangeLabel(start);

            const dayLabels = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];
            let weeklySeconds = 0;
            const rows = [];

            for (let i = 0; i < 7; i++) {
                const d = new Date(start);
                d.setDate(d.getDate() + i);
                const data = loadDataForDate(d);
                const seconds = data.totalSeconds || 0;
                weeklySeconds += seconds;

                const hours = seconds / 3600;
                const isToday = (new Date()).toDateString() === d.toDateString();
                const dateStr = `${pad2(d.getDate())}/${pad2(d.getMonth() + 1)}`;
                const fullDateIso = d.toISOString();

                // Danger sign if >11h
                const dangerSign = hours > 11 ?
                    '<span title="Attention : dépassement dangereux" style="color:#ff0000; font-weight:bold; margin-left:4px;">⚠</span>' : '';

                // Dynamic color
                const color = getColorCode(hours);

                rows.push(`
                    <div onclick="openOverrideModal('${fullDateIso}')" class="weekly-day-row flex items-center justify-between bg-gray-50 rounded-xl px-4 py-3 transition-colors ${isToday ? 'ring-2 ring-[#fee600]/70' : ''}">
                        <div class="flex items-center gap-3">
                            <div class="w-10 text-gray-700 font-semibold">${DICTIONARY[currentLang].days[i]}</div>
                            <div class="text-xs text-gray-400">${dateStr}</div>
                            ${dangerSign}
                        </div>
                        <div class="time-display text-gray-800 font-bold" style="color:${color}">${formatTime(seconds)}</div>
                    </div>
                `);
            }

            const weeklyHours = weeklySeconds / 3600;
            const weeklyColor = getWeeklyColorCode(weeklyHours);
            weeklyTotalEl.textContent = formatTime(weeklySeconds);
            weeklyTotalEl.style.color = weeklyColor;

            if (weeklyHours >= 50) {
                weeklyDangerEl.classList.remove('hidden');
                weeklyDangerEl.classList.add('inline-block');
                weeklyDangerEl.style.color = '#fff';
            } else {
                weeklyDangerEl.classList.add('hidden');
                weeklyDangerEl.classList.remove('inline-block');
            }

            weekDaysEl.innerHTML = rows.join('');
        }

        // Modal edit state
        let editingSessionIndex = null; // index in data.sessions

        function secondsSinceMidnight(d) {
            return d.getHours() * 3600 + d.getMinutes() * 60 + d.getSeconds();
        }

        function hhmmFromDate(d) {
            return `${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
        }

        function parseHHMM(str) {
            const m = /^([01]\d|2[0-3]):([0-5]\d)$/.exec(String(str || '').trim());
            if (!m) return null;
            return { h: parseInt(m[1], 10), min: parseInt(m[2], 10) };
        }

        function computeDurationSecondsFromTimes(startHHMM, endHHMM) {
            const s = parseHHMM(startHHMM);
            const e = parseHHMM(endHHMM);
            if (!s || !e) return null;
            const startSec = s.h * 3600 + s.min * 60;
            const endSec = e.h * 3600 + e.min * 60;
            let dur = endSec - startSec;
            if (dur < 0) dur += 24 * 3600; // crosses midnight
            return dur;
        }

        function openEditModal(index) {
            const data = loadData();
            const session = data.sessions[index];
            if (!session) return;
            if (isRunning) {
                alert(DICTIONARY[currentLang].alertStopFirst);
                return;
            }

            editingSessionIndex = index;

            const startDate = new Date(session.start);
            const endDate = new Date(session.end);

            document.getElementById('editStart').value = hhmmFromDate(startDate);
            document.getElementById('editEnd').value = hhmmFromDate(endDate);

            const hintEl = document.getElementById('editHint');
            const dateStr = `${pad2(startDate.getDate())}/${pad2(startDate.getMonth() + 1)}/${startDate.getFullYear()}`;
            // Use simple concatenation or make this a template in dictionary
            // For simplicity, we keep it partially dynamic or hardcoded, but better to genericize "Session of [date]"
            const sessionOf = currentLang === 'fr' ? 'Session du' : 'Session of';
            const duration = currentLang === 'fr' ? 'Durée actuelle :' : 'Current duration:';
            hintEl.textContent = `${sessionOf} ${dateStr} · ${duration} ${formatTime(session.duration || 0)}`;

            const modal = document.getElementById('editModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');

            // focus
            setTimeout(() => document.getElementById('editStart').focus(), 50);
        }

        function closeEditModal() {
            const modal = document.getElementById('editModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            editingSessionIndex = null;
        }

        function recomputeDayTotal(data) {
            data.totalSeconds = (data.sessions || []).reduce((acc, s) => acc + (s.duration || 0), 0);
        }

        function saveEditedSession() {
            if (editingSessionIndex === null) return;
            const data = loadData();
            const session = data.sessions[editingSessionIndex];
            if (!session) return;

            const startVal = document.getElementById('editStart').value;
            const endVal = document.getElementById('editEnd').value;
            const newDur = computeDurationSecondsFromTimes(startVal, endVal);

            if (newDur === null) {
                alert(DICTIONARY[currentLang].alertInvalidTime);
                return;
            }
            if (newDur === 0) {
                alert(DICTIONARY[currentLang].alertZeroDuration);
                return;
            }

            // Build new timestamps while preserving the session's original date as the base.
            const base = new Date(session.start);
            base.setSeconds(0, 0);

            const s = parseHHMM(startVal);
            const e = parseHHMM(endVal);

            const startDate = new Date(base);
            startDate.setHours(s.h, s.min, 0, 0);

            const endDate = new Date(base);
            endDate.setHours(e.h, e.min, 0, 0);
            if (endDate.getTime() <= startDate.getTime()) {
                endDate.setDate(endDate.getDate() + 1);
            }

            session.start = startDate.getTime();
            session.end = endDate.getTime();
            session.duration = Math.floor((session.end - session.start) / 1000);

            recomputeDayTotal(data);
            saveData(data);

            closeEditModal();
            updateTotalTime();
            updateSessionsList();
            updateWeeklySummary();
        }

        function deleteSessionFromModal() {
            if (editingSessionIndex === null) return;
            deleteSession(editingSessionIndex);
            closeEditModal();
        }

        // Update sessions list
        function deleteSession(index) {
            // index refers to the original order in data.sessions
            if (!confirm(DICTIONARY[currentLang].confirmDelete)) return;
            const data = loadData();
            if (!data.sessions[index]) return;
            data.sessions.splice(index, 1);
            recomputeDayTotal(data);
            saveData(data);
            updateTotalTime();
            updateSessionsList();
            updateWeeklySummary();
        }

        // Update sessions list
        function updateSessionsList() {
            const data = loadData();
            const container = document.getElementById('sessionsList');

            if (data.sessions.length === 0) {
                container.innerHTML = `<p class="text-gray-400 text-sm text-center py-4">${DICTIONARY[currentLang].noSessions}</p>`;
                return;
            }

            // Show newest first, but keep ability to target correct entry
            const items = data.sessions.map((session, index) => ({ session, index })).reverse();

            container.innerHTML = items.map(({ session, index }) => {
                const startDate = new Date(session.start);
                const endDate = new Date(session.end);
                const locale = currentLang === 'fr' ? 'fr-FR' : 'en-GB';
                const startStr = startDate.toLocaleTimeString(locale, { hour: '2-digit', minute: '2-digit' });
                const endStr = endDate.toLocaleTimeString(locale, { hour: '2-digit', minute: '2-digit' });
                const sessionHours = session.duration / 3600;
                const color = getColorCode(sessionHours);

                return `
                    <div class="session-item bg-gray-50 rounded-lg p-3 pl-4">
                        <div class="flex justify-between items-center gap-3">
                            <div class="min-w-0">
                                <button onclick="openEditModal(${index})" class="clickable-time text-left text-gray-600 text-sm font-semibold truncate w-full" title="Cliquer pour modifier" style="color:${color}">
                                    ${startStr} - ${endStr}
                                </button>
                                <div class="text-gray-400 text-xs">${formatTime(session.duration)}</div>
                            </div>
                            <div class="flex items-center gap-2">
                                <span class="text-gray-800 font-bold text-sm whitespace-nowrap" style="color:${color}">${formatTime(session.duration)}</span>
                                <button onclick="deleteSession(${index})" class="w-8 h-8 rounded-full bg-white hover:bg-red-50 text-gray-400 hover:text-red-600 transition-colors flex items-center justify-center" aria-label="Supprimer">
                                    <span class="text-lg leading-none">×</span>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Clear all sessions
        function clearSessions() {
            if (confirm(DICTIONARY[currentLang].confirmClearDay)) {
                if (isRunning) {
                    stopTimer();
                }
                const key = getTodayKey();
                localStorage.removeItem(key);
                localStorage.removeItem('timetracker_running');
                document.getElementById('currentTime').textContent = '00:00:00';
                updateTotalTime();
                updateSessionsList();
                updateWeeklySummary();
            }
        }

        function openRunningStartModal() {
            if (!isRunning || !startTime) return;
            const modal = document.getElementById('runningStartModal');
            const input = document.getElementById('runningStartInput');

            // Format pour datetime-local: YYYY-MM-DDTHH:mm
            const d = new Date(startTime);
            const year = d.getFullYear();
            const month = pad2(d.getMonth() + 1);
            const day = pad2(d.getDate());
            const hours = pad2(d.getHours());
            const minutes = pad2(d.getMinutes());

            input.value = `${year}-${month}-${day}T${hours}:${minutes}`;
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeRunningStartModal() {
            const modal = document.getElementById('runningStartModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        function saveRunningStart() {
            const input = document.getElementById('runningStartInput');
            if (!input.value) return;

            const newDate = new Date(input.value);
            if (isNaN(newDate.getTime())) {
                alert(DICTIONARY[currentLang].alertInvalidDate);
                return;
            }

            startTime = newDate.getTime();
            // Mettre à jour le stockage local
            localStorage.setItem('timetracker_running', JSON.stringify({
                startTime: startTime
            }));

            updateCurrentTime();
            closeRunningStartModal();
        }

        let overrideTargetDate = null;

        function openOverrideModal(isoDate) {
            overrideTargetDate = new Date(isoDate);
            const data = loadDataForDate(overrideTargetDate);
            const totalSec = data.totalSeconds || 0;

            const hours = Math.floor(totalSec / 3600);
            const mins = Math.floor((totalSec % 3600) / 60);

            document.getElementById('overrideHours').value = hours;
            document.getElementById('overrideMinutes').value = mins;

            const dayStr = `${pad2(overrideTargetDate.getDate())}/${pad2(overrideTargetDate.getMonth() + 1)}`;
            const prefix = currentLang === 'fr' ? 'Saisissez le temps total pour le' : 'Enter total time for';
            document.getElementById('overrideDayLabel').textContent = `${prefix} ${dayStr}.`;

            const modal = document.getElementById('overrideModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeOverrideModal() {
            const modal = document.getElementById('overrideModal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            overrideTargetDate = null;
        }

        function saveOverride() {
            if (!overrideTargetDate) return;

            const h = parseInt(document.getElementById('overrideHours').value) || 0;
            const m = parseInt(document.getElementById('overrideMinutes').value) || 0;

            const totalSeconds = (h * 3600) + (m * 60);

            const data = loadDataForDate(overrideTargetDate);
            data.totalSeconds = totalSeconds;
            // Clear sessions as override replaces them for consistency
            data.sessions = [];

            saveDataForDate(overrideTargetDate, data);

            closeOverrideModal();
            updateTotalTime();
            updateSessionsList();
            updateWeeklySummary();
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            initLanguage();
            checkRunningSession();
            updateTotalTime();
            updateSessionsList();
            updateWeeklySummary();
            updateUI();

            // Close modals with Escape
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeEditModal();
                    closeRunningStartModal();
                    closeOverrideModal();
                }
            });
        });
    </script>
</body>

</html>